
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Models
{
    public class BEG_VEN_CONV_REC_LOT
    {

        [NotMapped]
        public string Trigger_BEG_TRG_BUD_VEN_CONV_REC_LOT { get; set; } = `{"triggering_event":"UPDATE OR DELETE","trigger_body":"declare\n  --\n  VN_INDICE                  number;\n  VN_VLR_BAIXA               BEG_VEN_CONV_REC_LOT_ITEM.VLR_BAIXA%type;\n  VN_VLR_JUROS               BEG_VEN_CONV_REC_LOT_ITEM.VLR_JUROS%type;\n  VN_VLR_DESCONTO            BEG_VEN_CONV_REC_LOT_ITEM.VLR_DESCONTO%type;\n  vn_beg_ven_conv_rec_lot_id beg_ven_conv_rec_lot.beg_ven_conv_rec_lot_id%type;\n  --\n  cursor CITENS is\n    select LI.BEG_VEN_CONV_REC_LOT_ITEM_ID,\n           LI.BEG_CRC_TITULO_ID,\n           LI.VLR_TITULO\n      from BEG_VEN_CONV_REC_LOT_ITEM LI\n     where LI.BEG_VEN_CONV_REC_LOT_ID = :new.BEG_VEN_CONV_REC_LOT_ID\n       and LI.ISACTIVE = 'Y';\n  --\nbegin\n  --\n  if UPDATING('VLR_REPASSE') and :new.SIT_LOTE = 'B' then\n    VN_INDICE := :new.VLR_REPASSE / :new.VLR_LOTE_FINAL;\n    --\n    for RITENS in CITENS loop\n      VN_VLR_JUROS    := 0;\n      VN_VLR_DESCONTO := 0;\n      --\n      VN_VLR_BAIXA := ROUND(RITENS.VLR_TITULO * VN_INDICE, 2);\n    \n      if VN_VLR_BAIXA < RITENS.VLR_TITULO then\n        VN_VLR_DESCONTO := RITENS.VLR_TITULO - VN_VLR_BAIXA;\n      elsif VN_VLR_BAIXA > RITENS.VLR_TITULO then\n        VN_VLR_JUROS := VN_VLR_BAIXA - RITENS.VLR_TITULO;\n      else\n        VN_VLR_BAIXA := RITENS.VLR_TITULO;\n      end if;\n    \n      update BEG_VEN_CONV_REC_LOT_ITEM LI\n         set LI.VLR_DESCONTO = VN_VLR_DESCONTO,\n             LI.VLR_JUROS    = VN_VLR_JUROS,\n             LI.VLR_BAIXA    = VN_VLR_BAIXA\n       where LI.BEG_VEN_CONV_REC_LOT_ITEM_ID =\n             RITENS.BEG_VEN_CONV_REC_LOT_ITEM_ID;\n      --\n      if vn_beg_ven_conv_rec_lot_id is null then\n        vn_beg_ven_conv_rec_lot_id := ritens.beg_ven_conv_rec_lot_item_id;\n      end if;\n    end loop;\n    -- Verifica se existe diferenca de arredondamento para aocrreção -- AOK - 08/10/2009\n    if nvl(vn_beg_ven_conv_rec_lot_id, 0) > 0 then\n      vn_vlr_juros    := 0;\n      vn_vlr_desconto := 0;\n      select case\n               when sum(x.vlr_baixa) < :new.vlr_repasse then\n                :new.vlr_repasse - sum(x.vlr_baixa)\n               else\n                0\n             end juros,\n             case\n               when sum(x.vlr_baixa) > :new.vlr_repasse then\n                sum(x.vlr_baixa) - :new.vlr_repasse\n               else\n                0\n             end desconto\n        into vn_vlr_juros, vn_vlr_desconto\n        from beg_ven_conv_rec_lot_item x\n       where x.beg_ven_conv_rec_lot_id = :new.BEG_VEN_CONV_REC_LOT_ID;\n      --\n      if vn_vlr_juros > 0 or vn_vlr_desconto > 0 then\n        update BEG_VEN_CONV_REC_LOT_ITEM LI\n           set LI.VLR_DESCONTO = LI.VLR_DESCONTO + VN_VLR_DESCONTO,\n               LI.VLR_JUROS    = LI.VLR_JUROS + VN_VLR_JUROS,\n               LI.VLR_BAIXA    = LI.VLR_BAIXA + vn_vlr_juros -\n                                 vn_vlr_desconto\n         where LI.BEG_VEN_CONV_REC_LOT_ITEM_ID = vn_beg_ven_conv_rec_lot_id;\n      end if;\n    end if;\n  end if;\n\n  -- Quando lote estiver finalizado não pode permitir alteracoes\n  --if :new.SIT_LOTE = 'C' then -- AOK - 26/05/09\n  if UPDATING then\n    if :new.SIT_LOTE = 'C' and :old.SIT_LOTE = 'C' then\n      -- AOK - 26/05/09\n      RAISE_APPLICATION_ERROR(-20001,\n                              'Lote já esta finalizado, não permitido manutenção ');\n    end if;\n  end if;\n  if DELETING -- AOK - 26/05/09\n     and (:old.SIT_LOTE = 'C' or :old.DT_EMISSAO_RELATO is not null) then\n    if :old.SIT_LOTE = 'C' then\n      RAISE_APPLICATION_ERROR(-20002,\n                              'Lote já esta finalizado, não pode ser excluido ');\n    else\n      RAISE_APPLICATION_ERROR(-20003,\n                              'Relatorio ja foi emitido - não pode ser excluido ');\n    end if;\n  end if;\n\nend BEG_TRG_BUD_VEN_CONV_REC_LOT;\n"}`;
    
    }
}
