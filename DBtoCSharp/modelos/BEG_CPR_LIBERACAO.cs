
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Models
{
    public class BEG_CPR_LIBERACAO
    {

        [NotMapped]
        public string Trigger_TRG_BIU_BEG_CPR_LIBERACAO { get; set; } = `{"triggering_event":"INSERT OR UPDATE","trigger_body":"declare\n  /* ---------------------------------------------------------------------------------------------------\n   Objetivo(s)..: Trigger que valida a liberac?o de ordens de compra\n   Modulo.......: CPR - Compras\n   Analista.....: Tiago Gabriel\n   Alterac?es:\n   Data        Desenvolvedor  Alterac?o\n   23/09/2006  Tiago Gabriel  Criac?o.\n  --------------------------------------------------------------------------------------------------- */\n  pragma autonomous_transaction;\n  VC_MSG_ERRO                varchar2(200);\n  VN_DUMMY                   number;\n  VN_VLR_TOTAL_ORDEM         BEG_CPR_ORDEM.VLR_TOTAL_ORDEM%type;\n  VC_DOCSTATUS               BEG_CPR_ORDEM.DOCSTATUS%type;\n  VC_IND_CONTROLA_ALCADA_CPR BEG_CPR_COMPRADOR.IND_CONTROLA_ALCADA%type;\n  VN_VLR_SALDO_CPR           BEG_CPR_COMPRADOR.VLR_SALDO%type;\n  VN_BEG_VW_CPR_COMPRADOR_ID BEG_CPR_COMPRADOR.BEG_VW_CPR_COMPRADOR_ID%type;\n  VC_IND_CONTROLA_ALCADA_SUP BEG_CPR_COMPRADOR.IND_CONTROLA_ALCADA%type;\n  VN_VLR_SALDO_SUP           BEG_CPR_COMPRADOR.VLR_SALDO%type;\n\nbegin\n  -- Valida os dados da liberac?o\n  if :new.DT_UTILIZACAO is not null\n     and :new.DT_CANCELAMENTO is not null then\n    VC_MSG_ERRO := 'Para cancelamento a liberac?o n?o deve estar utilizazda!';\n    goto FIM;\n  end if;\n\n  if :new.IND_ALTERACAO = 'Y'\n     and :new.DT_CANCELAMENTO is null then\n    VC_MSG_ERRO := 'Liberac?o de ordens que foram alteradas deve ser cancelada!';\n    goto FIM;\n  end if;\n\n  -- Testa a unicidade de liberac?es para ordens\n  if NVL(:old.BEG_CPR_ORDEM_ID, 0) <> NVL(:new.BEG_CPR_ORDEM_ID, 0) then\n    select count(1)\n      into VN_DUMMY\n      from BEG_CPR_LIBERACAO\n     where BEG_CPR_ORDEM_ID = :new.BEG_CPR_ORDEM_ID\n       and DT_UTILIZACAO is null\n       and DT_CANCELAMENTO is null;\n  \n    if VN_DUMMY > 0 then\n      VC_MSG_ERRO := 'Ja existe liberac?o para a ordem informada!';\n      goto FIM;\n    end if;\n  end if;\n\n  -- Verifica ordem, comprador e supervisor\n  if NVL(:old.BEG_CPR_ORDEM_ID, 0) <> NVL(:new.BEG_CPR_ORDEM_ID, 0)\n     or NVL(:old.BEG_VW_CPR_COMPRADOR_ID, 0) <>\n     NVL(:new.BEG_VW_CPR_COMPRADOR_ID, 0) then\n  \n    select ORD.VLR_TOTAL_ORDEM,\n           ORD.DOCSTATUS,\n           CPR.IND_CONTROLA_ALCADA,\n           CPR.VLR_SALDO,\n           CPR.BEG_VW_CPR_COMPRADOR_ID,\n           SUP.IND_CONTROLA_ALCADA,\n           SUP.VLR_SALDO\n      into VN_VLR_TOTAL_ORDEM,\n           VC_DOCSTATUS,\n           VC_IND_CONTROLA_ALCADA_CPR,\n           VN_VLR_SALDO_CPR,\n           VN_BEG_VW_CPR_COMPRADOR_ID,\n           VC_IND_CONTROLA_ALCADA_SUP,\n           VN_VLR_SALDO_SUP\n      from BEG_CPR_ORDEM     ORD,\n           BEG_CPR_COMPRADOR CPR,\n           BEG_CPR_COMPRADOR SUP\n     where ORD.BEG_CPR_COMPRADOR_ID = CPR.BEG_CPR_COMPRADOR_ID\n       and CPR.BEG_VW_CPR_COMPRADOR_ID = SUP.BEG_CPR_COMPRADOR_ID(+)\n       and ORD.BEG_CPR_ORDEM_ID = :new.BEG_CPR_ORDEM_ID;\n  \n    -- Status da ordem\n    if VC_DOCSTATUS <> 'WC' then\n      VC_MSG_ERRO := 'Ordem n?o esta aguardando confirmac?o!';\n      goto FIM;\n    end if;\n  \n    -- Controle de alcada do comprador\n    if VC_IND_CONTROLA_ALCADA_CPR = 'N' then\n      VC_MSG_ERRO := 'Comprador da ordem n?o controla alcada!';\n      goto FIM;\n    end if;\n  \n    -- Valor da ordem\n    if VN_VLR_TOTAL_ORDEM <= VN_VLR_SALDO_CPR then\n      VC_MSG_ERRO := 'Comprador possui saldo para aprovar a ordem!';\n      goto FIM;\n    end if;\n  \n    -- Supervisor\n    if VN_BEG_VW_CPR_COMPRADOR_ID is null then\n      VC_MSG_ERRO := 'Comprador n?o possui supervisor!';\n      goto FIM;\n    else\n      if :new.BEG_VW_CPR_COMPRADOR_ID <> VN_BEG_VW_CPR_COMPRADOR_ID then\n        VC_MSG_ERRO := 'Supervisor n?o e responsavel pelo comprador da ordem!';\n        goto FIM;\n      end if;\n    end if;\n  \n    -- Supervisor sem alcada para liberac?o\n    if VC_IND_CONTROLA_ALCADA_SUP = 'Y'\n       and VN_VLR_TOTAL_ORDEM > VN_VLR_SALDO_SUP then\n      VC_MSG_ERRO := 'Supervisor sem saldo para liberar a ordem!';\n      goto FIM;\n    end if;\n  \n  end if;\n\n  <<FIM>>\n  if VC_MSG_ERRO is not null then\n    RAISE_APPLICATION_ERROR(-20001, VC_MSG_ERRO);\n  end if;\n\nend TRG_BIU_BEG_CPR_LIBERACAO;\n"}`;
    
    }
}
