
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Models
{
    public class BEG_VW_PRD_PRECO_PENDENTE
    {

        [NotMapped]
        public string Trigger_TRG_IOU_BEG_VW_PRD_PRECO_PEND { get; set; } = `{"triggering_event":"UPDATE","trigger_body":"declare\n  vn_dummy            Number;\n  vdt_inicio          beg_prd_preco.dt_inicio%Type;\n  --vn_beg_prd_preco_id beg_prd_preco.beg_prd_preco_id%Type;\n  --vc_ind_preco        VarChar2( 2 );\n\nbegin\n  if :old.ind_importado = 'Y'   and\n     not Updating( 'ISACTIVE' ) then\n    Raise_Application_Error( -20001, 'Preços importados não permitem alteração!' );\n  end if;\n\n  /* Tiago Gabriel em 28/07/2008\n     Deixou de inativar o preço anterior.\n  if :new.beg_prd_promocao_id is null then\n    vc_ind_preco := 'CI';\n  else\n    vc_ind_preco := 'PI';\n  end if;\n  */\n\n  if :new.ind_aprovado = 'Y' then\n\n    -- Se está aprovando um preço com data posterior ao início original, atualiza nova data\n    if :new.dt_inicio < :new.dt_aprovacao then\n\n      -- Verifica se já existe preço para o produto\n      select Count( 1 )\n        into vn_dummy\n        from beg_prd_preco\n       where ad_org_id                  =  :new.ad_org_id\n         and beg_produto_id             =  :new.beg_produto_id\n         and beg_prd_sku_id             =  :new.beg_prd_sku_id\n         and Nvl( beg_cel_plano_id, 0 ) =  Nvl( :new.beg_cel_plano_id, 0 )\n         and beg_prd_preco_id           <> BEG_FNC_PRD_Preco( :new.ad_org_id\n                                                            , :new.beg_produto_id\n                                                            , :new.beg_prd_sku_id\n                                                            , :new.beg_cel_plano_id\n                                                            , 'VI' )\n         and rownum                     =  1;\n\n      if vn_dummy = 0 then\n        vdt_inicio := Trunc( sysdate );\n      elsif vn_dummy > 0 then\n        vdt_inicio := Trunc( sysdate ) + 1;\n      end if;\n\n    else\n      vdt_inicio := :new.dt_inicio;\n    end if;\n\n    -- Valida vínculo de celulares\n    if :new.beg_cel_plano_id is not null then\n      if BEG_FNC_CEL_Plano( :new.ad_org_id\n                          , :new.beg_produto_id\n                          , :new.beg_cel_plano_id\n                          , :new.dt_inicio ) = 'N' then\n        Raise_Application_Error( -20001, 'Vínculo de produto e plano de celular inativo!' );\n      end if;\n    end if;\n\n    -- Valida unicidade do preço aprovado\n    select Count( 1 )\n      into vn_dummy\n      from beg_prd_preco\n     where ad_org_id                     =  :new.ad_org_id\n       and beg_produto_id                =  :new.beg_produto_id\n       and beg_prd_sku_id                =  :new.beg_prd_sku_id\n       and dt_inicio                     =  vdt_inicio\n       and Nvl( beg_prd_promocao_id, 0 ) =  Nvl( :new.beg_prd_promocao_id, 0 )\n       and Nvl( beg_prd_conjunto_id, 0 ) =  Nvl( :new.beg_prd_conjunto_id, 0 )\n       and Nvl( beg_cel_plano_id, 0 )    =  Nvl( :new.beg_cel_plano_id, 0 )\n       and beg_prd_preco_id              <> :new.beg_vw_prd_preco_pendente_id\n       and rownum                        =  1;\n\n    if vn_dummy > 0 then\n      Raise_Application_Error( -20001, 'Já existe o mesmo preço aprovado!' );\n    end if;\n\n    BEG_PCK_PRD_Produtos.vb_proc_vw_pendente := true;\n\n    update beg_prd_preco\n       set updated             = :new.updated\n         , updatedby           = :new.updatedby\n         , beg_cel_plano_id    = :new.beg_cel_plano_id\n         , isactive            = 'Y'\n         , ind_aprovado        = 'Y'\n         , ind_lista_aprovacao = 'N'\n         , dt_aprovacao        = Trunc( sysdate )\n         , dt_inicio_original  = Nvl( :new.dt_inicio_original\n                                    , :new.dt_inicio )\n         , dt_inicio           = trunc( sysdate ) --vdt_inicio -- AOK - 20/10/2008\n         , vlr_preco           = :new.vlr_preco\n         , obs                 = :new.obs\n     where beg_prd_preco_id = :new.beg_vw_prd_preco_pendente_id;\n\n    /* Tiago Gabriel em 28/07/2008\n       Deixou de inativar o preço anterior.\n    vn_beg_prd_preco_id := BEG_FNC_PRD_Preco( :new.ad_org_id\n                                            , :new.beg_produto_id\n                                            , :new.beg_prd_sku_id\n                                            , :new.beg_cel_plano_id\n                                            , vc_ind_preco\n                                            , :new.dt_inicio\n                                            , :new.beg_prd_conjunto_id\n                                            , pi_ind_fixa_org => 'Y' );\n\n    if vn_beg_prd_preco_id > 0 then\n      update beg_prd_preco\n         set isactive = 'N'\n       where beg_prd_preco_id = vn_beg_prd_preco_id;\n    end if;\n    */\n\n  else\n\n    beg_pck_prd_produtos.vb_proc_vw_pendente := true;\n\n    update beg_prd_preco\n       set updated             = :new.updated\n         , updatedby           = :new.updatedby\n         , beg_cel_plano_id    = :new.beg_cel_plano_id\n         , isactive            = :new.isactive\n         , ind_aprovado        = 'N'\n         , ind_lista_aprovacao = 'Y'\n         , dt_aprovacao        = null\n         , dt_inicio_original  = Nvl( :new.dt_inicio_original\n                                    , :new.dt_inicio )\n         , dt_inicio           = Nvl( :new.dt_inicio_original\n                                    , :new.dt_inicio )\n         , vlr_preco           = :new.vlr_preco\n         , obs                 = :new.obs\n     where beg_prd_preco_id = :new.beg_vw_prd_preco_pendente_id;\n\n    /* Tiago Gabriel em 28/07/2008\n       Deixou de inativar o preço anterior.\n    vn_beg_prd_preco_id := beg_fnc_prd_preco( :new.ad_org_id\n                                            , :new.beg_produto_id\n                                            , :new.beg_prd_sku_id\n                                            , :new.beg_cel_plano_id\n                                            , vc_ind_preco\n                                            , :new.dt_inicio - 1\n                                            , :new.beg_prd_conjunto_id\n                                            , pi_isactive     => null\n                                            , pi_ind_fixa_org => 'Y' );\n\n    if vn_beg_prd_preco_id > 0 then\n      update beg_prd_preco\n         set isactive = 'Y'\n       where beg_prd_preco_id = vn_beg_prd_preco_id;\n    end if;\n    */\n\n  end if;\n\n  beg_pck_prd_produtos.vb_proc_vw_pendente := false;\n\nend TRG_IOU_BEG_VW_PRD_PRECO_PEND;\n"}`;
    
    }
}
