
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Models
{
    public class BEG_INS_LIBERACAO
    {

        [NotMapped]
        public string Trigger_TRG_BIUD_BEG_INS_LIBERACAO { get; set; } = `{"triggering_event":"INSERT OR UPDATE OR DELETE","trigger_body":"declare\n  /*-----------------------------------------------------------------------------------------------------\n  Objetivo(s)..: Trigger que inclui os registros em inspec?o na tabela de itens para posterior liberac?o.\n  Modulo.......: CPR - Compras\n  Analista.....: Tiago Gabriel\n  Alterac?es:\n  Data        Desenvolvedor  Alterac?o\n  18/07/2006  Tiago Gabriel  Criac?o.\n  -----------------------------------------------------------------------------------------------------*/\n  VC_MSG_ERRO varchar2(200);\n\nbegin\n  -- Verifica o status da liberac?o\n  if UPDATING then\n    if :old.DOCSTATUS = :new.DOCSTATUS then\n      if :new.DOCSTATUS <> 'WC' then\n        VC_MSG_ERRO := 'Somente e possivel alterar liberac?es que est?o aguardando confirmac?o!';\n        goto FIM;\n      end if;\n    else\n      goto FIM;\n    end if;\n  end if;\n\n  -- Se esta excluindo uma liberac?o, exclui tambem os itens.\n  if DELETING then\n  \n    -- Verifica o status da liberac?o\n    if :old.DOCSTATUS <> 'WC' then\n      VC_MSG_ERRO := 'Somente e possivel excluir liberac?es ainda n?o processadas!';\n      goto FIM;\n    end if;\n  \n    -- Exclui os itens\n    delete from BEG_INS_LIBERACAO_ITEM\n     where BEG_INS_LIBERACAO_ID = :old.BEG_INS_LIBERACAO_ID;\n  \n    goto FIM;\n  end if;\n\n  -- Insere os itens a serem liberados de acordo com os parametros informados\n  insert into BEG_INS_LIBERACAO_ITEM LIB_IT\n    (LIB_IT.BEG_INS_LIBERACAO_ITEM_ID,\n     LIB_IT.AD_CLIENT_ID,\n     LIB_IT.AD_ORG_ID,\n     LIB_IT.ISACTIVE,\n     LIB_IT.CREATEDBY,\n     LIB_IT.UPDATEDBY,\n     LIB_IT.VLR_SUGERIDO,\n     LIB_IT.VLR_VIGENTE,\n     LIB_IT.PER_VARIACAO,\n     LIB_IT.VLR_CUSTO,\n     LIB_IT.QTD_LIBERAR,\n     LIB_IT.BEG_INS_LIBERACAO_ID,\n     LIB_IT.BEG_INS_NFE_ITEM_ID)\n    select BEG_FNC_AD_SEQUENCE('BEG_INS_LIBERACAO_ITEM'), -- beg_ins_liberacao_item_id\n           :new.AD_CLIENT_ID, -- ad_client_id\n           :new.AD_ORG_ID, -- ad_org_id\n           'N', -- isactive\n           :new.UPDATEDBY, -- createdby\n           :new.UPDATEDBY, -- updatedby\n           ROUND(INS_IT.VLR_SUGERIDO, 2), -- vlr_sugerido\n           ROUND(INS_IT.VLR_VIGENTE, 2), -- vlr_vigente\n           ROUND(INS_IT.PER_VARIACAO, 3), -- per_variacao\n           ROUND(INS_IT.VLR_TABELA, 2), -- vlr_custo\n           INS_IT.QTD_BLOQUEADA, -- qtd_liberar\n           :new.BEG_INS_LIBERACAO_ID, -- beg_ins_liberacao_id\n           INS_IT.BEG_VW_INS_NFE_ITEM_ID -- beg_ins_nfe_item_id\n      from BEG_VW_INS_NFE_ITEM INS_IT,\n           BEG_CPR_NFE         NFE\n     where INS_IT.BEG_CPR_NFE_ID = NFE.BEG_CPR_NFE_ID\n       and INS_IT.BEG_PRODUTO_ID =\n           NVL(:new.BEG_PRODUTO_ID, INS_IT.BEG_PRODUTO_ID)\n       and NFE.BEG_CPR_NFE_ID =\n           NVL(:new.BEG_CPR_NFE_ID, NFE.BEG_CPR_NFE_ID)\n       and NFE.BEG_VW_FORNECEDOR_ID =\n           NVL(:new.BEG_VW_FORNECEDOR_ID, NFE.BEG_VW_FORNECEDOR_ID)\n       and NFE.DT_EMISSAO between NVL(:new.DT_INICIAL, NFE.DT_EMISSAO) and\n           NVL(:new.DT_FINAL, NFE.DT_EMISSAO)\n       and INS_IT.QTD_BLOQUEADA > 0\n       and not exists (select 1\n              from BEG_INS_LIBERACAO_ITEM LIB_IT_IN\n             where LIB_IT_IN.BEG_INS_NFE_ITEM_ID =\n                   INS_IT.BEG_VW_INS_NFE_ITEM_ID\n               and LIB_IT_IN.BEG_INS_LIBERACAO_ID =\n                   :new.BEG_INS_LIBERACAO_ID);\n\n  if sql%rowcount = 0 then\n    VC_MSG_ERRO := 'Nenhum item inserido para os paramentros informados!';\n    goto FIM;\n  end if;\n\n  <<FIM>>\n  if VC_MSG_ERRO is not null then\n    RAISE_APPLICATION_ERROR(-20001, VC_MSG_ERRO);\n  end if;\n\nend TRG_BIUD_BEG_INS_LIBERACAO;\n"}`;
    
    }
}
